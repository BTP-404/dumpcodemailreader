sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/model/json/JSONModel","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/m/MessageToast","sap/ui/core/Fragment","sap/m/PDFViewer"],function(e,t,i,a,n,o,s){"use strict";return e.extend("com.mailprocessor.controller.MailBox",{onInit:function(){var e=this.getOwnerComponent().getModel();this.getView().setModel(e);var t=this.getView().byId("mailTable");var i=t.getBinding("items");var a=this.getView().byId("panel");i.attachDataRequested(function(){a.setBusy(true)});i.attachDataReceived(function(){a.setBusy(false)})},onSearch:function(){var e=this.getView(),t=e.byId("inputFrom").getValue(),n=e.byId("inputDate").getDateValue(),o=e.byId("inputTime").getValue(),s=e.byId("inputSubject").getValue();var r=[];if(t){r.push(new i("sender",a.Contains,t))}if(n){r.push(new i("date",a.EQ,n))}if(o){r.push(new i("time",a.EQ,o))}if(s){r.push(new i("subject",a.Contains,s))}var h=e.byId("mailTable"),l=h.getBinding("items");var c=this.getView().byId("panel");c.setBusy(true);l.filter(r);l.attachEventOnce("dataReceived",function(){c.setBusy(false)})},onShowAttachments:function(e){var i=e.getSource().getParent();var a=i.getBindingContext();var o=a.getProperty("ID");if(!this._oAttachmentDialog){this._oAttachmentDialog=sap.ui.xmlfragment(this.getView().getId(),"com.mailprocessor.fragments.AttachmentDialog",this);this.getView().addDependent(this._oAttachmentDialog)}var s=this.getView().byId("panel");s.setBusy(true);this._fetchAttachments(o).then(function(e){var i=new t({attachments:e});this._oAttachmentDialog.setModel(i);this._oAttachmentDialog.open();s.setBusy(false)}.bind(this)).catch(function(e){n.show("Error fetching attachments.");console.error("Error fetching attachments:",e);s.setBusy(false)})},_fetchAttachments:function(e){var t=this.getView().getModel();return t.bindList(`/EmailData(${e})/attachments`).requestContexts().then(function(e){return e.map(function(e){return e.getObject()})})},onPreviewAttachment:function(e){var t=e.getSource().getBindingContext();var i=t.getProperty("fileType");var a=t.getProperty("file");if(!this._oPreviewDialog){this._oPreviewDialog=sap.ui.xmlfragment(this.getView().getId(),"com.mailprocessor.fragments.Attachment",this);this.getView().addDependent(this._oPreviewDialog)}var r=o.byId(this.getView().getId(),"filePreview");if(i==="application/pdf"){var h=atob(a);var l=new Array(h.length);for(var c=0;c<h.length;c++){l[c]=h.charCodeAt(c)}var g=new Uint8Array(l);var u=new Blob([g],{type:"application/pdf"});var p=URL.createObjectURL(u);if(!this._pdfViewer){this._pdfViewer=new s({title:"PDF Preview",showDownloadButton:false,width:"auto",height:"600px"});this.getView().addDependent(this._pdfViewer)}this._pdfViewer.setSource(p);this._pdfViewer.open();this._pdfViewer.attachAfterClose(function(){URL.revokeObjectURL(p)})}else if(i.startsWith("image/")){var d="<img src='data:"+i+";base64,"+a+"' style='max-width: 100%; max-height: 400px;' />";r.setContent(d)}else if(i==="text/plain"){var f=atob(a);r.setContent("<pre>"+f+"</pre>")}else{n.show("Unsupported file type for preview.")}this._oPreviewDialog.open()},onClosePreviewDialog:function(){if(this._oPreviewDialog){this._oPreviewDialog.close()}},onCloseAttachmentDialog:function(){if(this._oAttachmentDialog){this._oAttachmentDialog.close()}}})});
//# sourceMappingURL=MailBox.controller.js.map